#!/usr/bin/env bash
set -e
CR=`echo $'\n> '`
FILE_DIR="$0"
EQDOCK_ROOT_DIR="${FILE_DIR%/*}/../"

echo "Hello eqdock!"

. "${EQDOCK_ROOT_DIR}bin/helperDocker.lib"
checkDockerMachineActive

. "${EQDOCK_ROOT_DIR}bin/helperECCUBE.lib"

ECCUBE_VERSION=`checkFromTheBeginningOrTheMiddle`
echo "$ECCUBE_VERSION"

. "${EQDOCK_ROOT_DIR}bin/helperDB.lib"

DB_KIND=`setDBKind`
echo "$DB_KIND"

DB_VERSION=`setDBVersion "${DB_KIND}"`
echo "$DB_VERSION"

DB_NAME=`setDBName`
echo "$DB_NAME"

DB_USER=`setDBUser`
echo "$DB_USER"

DB_PASSWD=`setDBPasswd`
echo "$DB_PASSWD"

if [ "_${DB_KIND}" = "_mysql" ]; then
  DB_ROOT_PASSWD=`setDBRootPasswd`
  echo "$DB_ROOT_PASSWD"
fi

. "${EQDOCK_ROOT_DIR}bin/helperPHP.lib"

PHP_VERSION=`setPHPVersion "${ECCUBE_VERSION}"`
echo "$PHP_VERSION"

# git clone終了を待つ
wait

createEccubeEnv "$DB_KIND" "$DB_VERSION" "$DB_NAME" "$DB_USER" "$DB_PASSWD"

copyDockerMaterial "$DB_KIND"

rewriteDockerfile "$DB_KIND" "$DB_VERSION" "$PHP_VERSION"

rewriteDockerCompose "$DB_KIND" "$DB_NAME" "$DB_USER" "$DB_PASSWD" "$DB_ROOT_PASSWD"

upDockerCompose
